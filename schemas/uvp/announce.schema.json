{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://evidenceos.dev/schemas/uvp/announce.schema.json",
  "title": "UVP Announce",
  "type": "object",
  "additionalProperties": false,
  "required": ["uvp_version", "session_id", "pds_manifest"],
  "properties": {
    "uvp_version": {"type": "string", "minLength": 1},
    "session_id": {"type": "string", "minLength": 1},
    "pds_manifest": {"$ref": "#/$defs/pds_manifest"}
  },
  "$defs": {
    "pds_manifest": {
      "type": "object",
      "additionalProperties": false,
      "required": ["manifest_id", "reality_gates", "ewl_policy"],
      "properties": {
        "manifest_id": {"type": "string", "minLength": 1},
        "reality_gates": {"$ref": "#/$defs/reality_gates"},
        "ewl_policy": {"$ref": "#/$defs/ewl_policy"},
        "canary_config": {"$ref": "#/$defs/canary_config"}
      }
    },
    "reality_gates": {
      "type": "object",
      "additionalProperties": false,
      "required": ["require_physhir", "require_causal_dag", "require_canary"],
      "properties": {
        "require_physhir": {"type": "boolean"},
        "require_causal_dag": {"type": "boolean"},
        "require_canary": {"type": "boolean"}
      }
    },
    "ewl_policy": {
      "type": "object",
      "additionalProperties": false,
      "required": ["null_p", "alt_p", "initial_wealth", "bankruptcy_floor"],
      "properties": {
        "null_p": {
          "type": "number",
          "exclusiveMinimum": 0,
          "exclusiveMaximum": 1
        },
        "alt_p": {
          "type": "number",
          "exclusiveMinimum": 0,
          "exclusiveMaximum": 1
        },
        "initial_wealth": {"type": "number", "exclusiveMinimum": 0},
        "bankruptcy_floor": {"type": "number", "minimum": 0},
        "leakage_budget_bits": {"type": "number", "minimum": 0}
      }
    },
    "canary_config": {
      "type": "object",
      "additionalProperties": false,
      "required": ["data_batch", "tolerance", "transforms", "evaluator"],
      "properties": {
        "data_batch": {
          "type": "object",
          "additionalProperties": {
            "type": "array",
            "minItems": 1,
            "items": {"type": "number"}
          }
        },
        "tolerance": {"type": "number", "minimum": 0},
        "transforms": {
          "type": "array",
          "items": {"$ref": "#/$defs/transform"}
        },
        "evaluator": {"$ref": "#/$defs/evaluator"},
        "pulse": {"$ref": "#/$defs/canary_pulse"}
      }
    },
    "canary_pulse": {
      "type": "object",
      "additionalProperties": false,
      "required": ["every_n_settlements", "probability"],
      "properties": {
        "every_n_settlements": {"type": "integer", "minimum": 0},
        "probability": {"type": "number", "minimum": 0, "maximum": 1},
        "seed": {"type": "integer"},
        "require_on_first": {"type": "boolean"}
      }
    },
    "transform": {
      "oneOf": [
        {"$ref": "#/$defs/shuffle"},
        {"$ref": "#/$defs/add_noise"},
        {"$ref": "#/$defs/rescale"}
      ]
    },
    "shuffle": {
      "type": "object",
      "additionalProperties": false,
      "required": ["type", "var"],
      "properties": {
        "type": {"const": "shuffle"},
        "var": {"type": "string", "minLength": 1}
      }
    },
    "add_noise": {
      "type": "object",
      "additionalProperties": false,
      "required": ["type", "var", "sigma", "seed"],
      "properties": {
        "type": {"const": "add_noise"},
        "var": {"type": "string", "minLength": 1},
        "sigma": {"type": "number", "minimum": 0},
        "seed": {"type": "integer"}
      }
    },
    "rescale": {
      "type": "object",
      "additionalProperties": false,
      "required": ["type", "var", "factor"],
      "properties": {
        "type": {"const": "rescale"},
        "var": {"type": "string", "minLength": 1},
        "factor": {"type": "number"}
      }
    },
    "evaluator": {
      "type": "object",
      "additionalProperties": false,
      "required": ["type", "variable"],
      "properties": {
        "type": {"const": "mean"},
        "variable": {"type": "string", "minLength": 1}
      }
    }
  }
}
