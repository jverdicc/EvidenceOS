# External Policy Oracles

Policy oracles are third-party **veto-only** “super judges” evaluated by the daemon after canonical output is produced. They are untrusted code and run inside a deterministic Wasm sandbox with no imports.

## Threat model and safety

- Oracle code is untrusted.
- Wasm plugins are validated to have:
  - exported `memory`
  - exported `alloc(i32)->i32`
  - exported `policy_oracle_decide(i32,i32)->i32`
  - **zero imports**
- Any trap, fuel exhaustion, OOM, invalid return code, or malformed module is fail-closed (`policy oracle failure`) and treated conservatively.
- Decisions are veto-only: `Pass`, `DeferToHeavy`, `Reject`.
- Oracles cannot certify claims and cannot increase evidence wealth/e-value.

## ABI

Decision code returned by `policy_oracle_decide`:

- `0` = pass
- `1` = defer
- `2` = reject
- any other code = invalid (fail-closed)

Input is canonical JSON bytes generated by the kernel from public-only fields.

## Manifest and trust store

Install under `<data_dir>/policy-oracles/`:

- `*.json` manifest(s)
- corresponding `.wasm`
- optional `trusted_keys.json`:

```json
{ "trusted_ed25519_pubkeys_hex": ["..."] }
```

Manifest schema is `evidenceos.v1.policy_oracle_manifest` with pinned `wasm_sha256_hex`, resource caps, and signature fields. If `require_signature=true`, signature verification is mandatory and signer must be in trust store.

Manifest signatures are Ed25519 over canonicalized JSON bytes with sorted keys and with `signature_ed25519_hex` excluded from the signed payload.

## Deployment

1. Place wasm + manifest into `<data_dir>/policy-oracles/`.
2. (Optional/Recommended) add trusted publisher keys in `trusted_keys.json`.
3. Start daemon. Invalid plugin config fails startup by default.
4. Set `EVIDENCEOS_ALLOW_ORACLE_LOAD_FAILURE=true` only for break-glass environments.

## Auditing receipts

Each non-empty policy evaluation is captured in `ClaimCapsule.policy_oracle_receipts`:

- `oracle_id`
- `manifest_hash_hex`
- `wasm_hash_hex`
- `decision`
- `reason_code`

This lets verifiers reproduce which policy set was active for an execution.

UVP alignment: Oracle resolution and canonical realization are enforced as canonical-bytes-first before policy effects are applied (Module B: Oracle Resolution… §10.1–10.5; Canonical Realization §5.1).
